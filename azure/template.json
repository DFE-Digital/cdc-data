{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "serviceIdentifier": {
      "type": "string",
      "minLength": 4,
      "maxLength": 4
    },
    "environment": {
      "type": "string",
      "defaultValue": "d",
      "allowedValues": [
        "d",
        "t",
        "p"
      ]
    },
    "environmentName": {
      "type": "string",
      "defaultValue": "DEV",
      "allowedValues": [
        "DEV",
        "TEST",
        "OAT",
        "PROD"
      ]
    },
    "environmentInstance": {
      "type": "string",
      "minLength": 2,
      "maxLength": 2,
      "defaultValue": "01"
    },
    "coreResourceGroupEnvironmentInstance": {
      "type": "string",
      "minLength": 2,
      "maxLength": 2,
      "defaultValue": "01"
    },
    "vNetInstance": {
      "type": "string",
      "minLength": 2,
      "maxLength": 2,
      "defaultValue": "01"
    },
    "subnetInstance": {
      "type": "string",
      "minLength": 2,
      "maxLength": 2,
      "defaultValue": "01"
    },
    "sqlServerUsername": {
      "type": "string",
      "minLength": 6,
      "maxLength": 20
    },
    "sqlServerPassword": {
      "type": "securestring",
      "minLength": 12
    },
    "cdcDocumentsFileShareName": {
      "type": "string",
      "defaultValue": "cdcdocuments"
    },
    "appName": {
      "type": "string",
      "maxLength": 8
    }
  },
  "variables": {

    "namePrefix": "[concat(parameters('serviceIdentifier'), parameters('environment'), parameters('environmentInstance'))]",
    "appNamePrefix": "[concat(variables('namePrefix'), '-', parameters('appName'))]",

    "storageAccountName": "[concat(variables('namePrefix'), 'cdcdocs', 'sa01')]",
    "storageAccountId": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",

    "fileShareName": "[concat(variables('storageAccountName'), '/default/', parameters('cdcDocumentsFileShareName'))]",

    "corePrefix": "[concat(parameters('serviceIdentifier'), parameters('environment'), parameters('coreResourceGroupEnvironmentInstance'), '-core')]",
    "vNetName": "[concat(concat(variables('corePrefix'), '-vn-'), parameters('vNetInstance'))]",
    "subnetName": "[concat(variables('corePrefix'), '-sn-', parameters('subnetInstance'))]",
    "subnetId": "[resourceId(variables('corePrefix'), 'Microsoft.Network/virtualNetworks/subnets', variables('vNetName'), variables('subnetName'))]",

    "sqlServerName": "[concat(variables('appNamePrefix'), '-sql-01')]",
    "cdcMasteredDataDbName": "[concat(variables('namePrefix'), '-CDC-Mastered-Data')]"

  },
  "resources": [

    {
      "apiVersion": "2019-06-01",
      "name": "[variables('storageAccountName')]",
      "type": "Microsoft.Storage/storageAccounts",
      "location": "[resourceGroup().location]",
      "tags": {
        "environment": "[parameters('environmentName')]",
        "app": "[parameters('appName')]"
      },
      "sku": {
        "name": "Standard_LRS",
        "tier": "Standard"
      },
      "kind": "StorageV2",
      "properties": {
        "networkAcls": {
          "bypass": "none",
          "virtualNetworkRules": [
            {
              "id": "[variables('subnetId')]"
            }
          ],
          "defaultAction": "Deny"
        },
        "supportsHttpsTrafficOnly": true,
        "encryption": {
          "services": {
            "file": {
              "enabled": true
            },
            "blob": {
              "enabled": true
            }
          },
          "keySource": "Microsoft.Storage"
        },
        "accessTier": "Hot"
      }
    },
    {
      "apiVersion": "2020-08-01-preview",
      "name": "[variables('fileShareName')]",
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "dependsOn": [
        "[variables('storageAccountId')]"
      ]
    },

    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2015-05-01-preview",
      "name": "[variables('sqlServerName')]",
      "location": "[resourceGroup().location]",
      "tags": {
        "environment": "[parameters('environment')]",
        "app": "[parameters('appName')]"
      },
      "kind": "v12.0",
      "properties": {
        "administratorLogin": "[parameters('sqlServerUsername')]",
        "administratorLoginPassword": "[parameters('sqlServerPassword')]",
        "version": "12.0"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2017-10-01-preview",
      "name": "[concat(variables('sqlServerName'), '/', variables('cdcMasteredDataDbName'))]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ],
      "tags": {
        "environment": "[parameters('environment')]",
        "app": "[parameters('appName')]"
      },
      "sku": {
        "name": "Basic",
        "tier": "Basic",
        "capacity": 5
      },
      "kind": "v12.0,user",
      "properties": {
        "collation": "SQL_Latin1_General_CP1_CI_AS",
        "catalogCollation": "SQL_Latin1_General_CP1_CI_AS",
        "zoneRedundant": false
      }
    }

  ],
  "outputs": {
  }
}